function Approval(){this.switchStr=!0,this.expenseImageUrl=[],this.expenseImageName=[],this.detailid="",this.flag=!0,this.config={productType:document.querySelector("#productType"),myModal:document.querySelector("#myModal"),addBtn:document.querySelector("#addBtn"),inWrap:document.querySelector("#inWrap"),cashierWrap:document.querySelector("#cashierWrap"),bankAccount:document.querySelector("#bankAccount"),accountName:document.querySelector("#accountName"),accounNumber:document.querySelector("#accounNumber"),expenseTotal:document.querySelector("#expenseTotal"),epUserWrap:document.querySelector("#epUserWrap"),departmentWrap:document.querySelector("#departmentWrap"),breadcrumb:document.querySelector("#breadcrumb"),approverWrap:document.querySelector("#approverWrap"),uploadBtn:document.querySelector("#uploadBtn"),uploadWrap:document.querySelector("#uploadWrap"),myFile:document.querySelector("#myFile"),deleteApproverWrap:document.querySelector("#deleteApproverWrap"),cancleBtn:document.querySelector("#cancleBtn"),confirmBtn:document.querySelector("#confirmBtn"),imgModal:document.querySelector("#imgModal"),cancleBtn_img:document.querySelector("#cancleBtn_img"),confirmBtn_img:document.querySelector("#confirmBtn_img"),addApprover:document.querySelector("#addApprover"),departWrapID:document.querySelector("#departWrapID"),closeBtn:document.querySelector("#closeBtn"),closeBtn_depart:document.querySelector("#closeBtn_depart"),menu:document.querySelector("#menu"),departSearch:document.querySelector("#departSearch"),departmentContent:document.querySelector("#departmentContent"),jobNum:document.querySelector("#jobNum"),groupWrap:document.querySelector("#groupWrap"),searchApprovalInput:document.querySelector("#searchApprovalInput")}}var slideout=new Slideout({panel:document.getElementById("panel"),menu:document.getElementById("menu"),padding:256,tolerance:70,touch:!1});Approval.prototype={throttle:function(e,a){var t=null;return function(){var o=this,n=arguments;clearTimeout(t),t=setTimeout(function(){e.apply(o,n)},a)}},throttleInput:function(e,a,t){var o=null,n=new Date;return function(){var r=this,s=arguments,l=new Date;clearTimeout(o),l-n>=t?(e.apply(r,s),n=l):o=setTimeout(function(){e.apply(r,s)},a)}},getDetailed:function(){var e=window.location.href,a=this;if(-1==e.indexOf("detailid"))throw $my.messageInfo.html("url错误").fadeIn("fast").delay("1000").fadeOut("slow"),new Error("url错误");var t=window.location.search;a.detailid=t.split("=")[1]},getSessionData:function(){var e=JSON.parse(sessionStorage.getItem("productType")),a=JSON.parse(sessionStorage.getItem("expenseUser")),t=sessionStorage.getItem("departName"),o=sessionStorage.getItem("departmentID"),n=sessionStorage.getItem("accountName"),r=sessionStorage.getItem("accounNumber"),s=sessionStorage.getItem("bankAccount"),l=sessionStorage.getItem("expenseTotal"),i=sessionStorage.getItem("jobNum"),d=sessionStorage.getItem("imgArr"),c=sessionStorage.getItem("imageNameArr"),p="",u="",f="",m="";if(this.config.departWrapID.value=t,this.config.departWrapID.dataset.departmentinputid=o,this.config.accountName.value=n,this.config.accounNumber.value=r,this.config.bankAccount.value=s,this.config.expenseTotal.value=l,this.config.jobNum.value=i,e&&($my.productTypeLength=e.length-1,e.length)){for(var g=0,h=e.length;g<h;g++){switch(g){case 0:u="报销一";break;case 1:u="报销二";break;case 2:u="报销三"}p+='<div id="appendChild" class="appendChild" data-index='+g+">",p+='<p class="titleMessage">'+u+"</p>",p+='<div class="container-fluid myContainer inputFile">',p+='<div class="row my-row">',p+='<div class="col-xs-3 col-sm-3 col-md-3 my-col">',p+="<span>报销类型</span>",p+="</div>",p+='<div class="col-xs-9 col-sm-9 col-md-9 my-col">',p+='<input type="text" class="product" data-productid='+e[g].producttypeID+" value="+e[g].productTypeName+' readonly="readonly" data-toggle="modal" data-target="#myModal" placeholder="请输入">',p+="</div>",p+="</div>",p+='<div class="row my-row">',p+='<div class="col-xs-4 col-sm-4 col-md-4 my-col">',p+="<span>报销金额(￥)</span>",p+="</div>",p+='<div class="col-xs-8 col-sm-8 col-md-8 my-col">',p+='<input type="number" class="itemAlltotals" data-count='+e[g].itemAlltotal+" value="+e[g].itemAlltotal+' placeholder="请输入">',p+="</div>",p+="</div>",p+='<div class="row my-row special-row">',p+='<div class="col-xs-3 col-sm-3 col-md-3 my-col">',p+="<span>费用说明</span>",p+='<span class="limit">(150字)</span>',p+="</div>",p+='<div class="col-xs-9 col-sm-9 col-md-9 my-col">',p+='<textarea class="remarks" placeholder="请输入" maxlength="150">'+e[g].remark+"</textarea>",p+="</div>",p+="</div>",p+="</div>",p+="</div>"}this.config.inWrap.innerHTML=p}if(a&&a.length){for(var g=0,h=a.length;g<h;g++)f+='<li class="nowrap addPeople deleteApprover" data-userid='+a[g].expenseUserID+' data-toggle="modal" data-target="#deleteApprover">'+a[g].expenseUserName+"</li>";this.config.approverWrap.insertAdjacentHTML("afterBegin",f)}if(d&&(d=d.split(","),c=c.split(","),d.length)){for(var g=0,h=d.length;g<h;g++)m+='<li class="myImg" data-toggle="modal" data-target="#imgModal">',m+="<img data-src="+d[g]+" src="+d[g]+"?imageView2/1/w/200/h/200 alt="+c[g]+">",m+="</li>";this.config.uploadWrap.insertAdjacentHTML("afterBegin",m)}},getProductType:function(){var e=this;$.ajax({url:getRoothPath+"/ddExpenses/userController/reviewType.do",success:function(a){if("{}"===JSON.stringify(a))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(a.status){case"true":var t=a.info;if("{}"===JSON.stringify(t))return $my.messageInfo.html("暂无报销类型").fadeIn("fast").delay("1000").fadeOut("slow"),!1;var o=t.data;if(!o.length)return $my.messageInfo.html("报销类型为空").fadeIn("fast").delay("1000").fadeOut("slow"),!1;for(var n="",r=0,s=o.length;r<s;r++)n+='<li class="list-group-item" data-producttypeid='+o[r].productTypeID+">"+o[r].productTypeName+"</li>";e.config.productType.innerHTML=n,e.selectProductType();break;case"failure":$my.messageInfo.html("查询错误").fadeIn("fast").delay("1000").fadeOut("slow")}}})},selectProductType:function(){var e=this,a="",t=this.config.productType.querySelectorAll("li");t=Array.prototype.slice.apply(t),$(e.config.inWrap).on("touchend",".product",function(e){e.preventDefault(),e.stopPropagation(),a=parseInt($(this).parents("#appendChild")[0].dataset.index),$(myModal).modal("show")});for(var o=0,n=t.length;o<n;o++)t[o].addEventListener("click",function(t){t.preventDefault(),t.stopPropagation();var o=this.innerHTML,n=this.dataset.producttypeid,r=e.config.inWrap.querySelectorAll(".appendChild");Array.prototype.forEach.call(r,function(e,t){a===t&&(e.querySelector(".product").value=o,e.querySelector(".product").dataset.productid=n)}),$(myModal).modal("hide")},!1)},addEvents:function(){void 0===$my.productTypeLength&&($my.productTypeLength=-1);var e=$my.productTypeLength,a="",t="",o=this;o.config.addBtn.addEventListener("click",function(){if(++e>2)return $my.messageInfo.html("最多添加2个报销").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(e){case 0:t="报销一";break;case 1:t="报销二";break;case 2:t="报销三"}a+='<div id="appendChild" class="appendChild" data-index='+e+">",a+='<p class="titleMessage">'+t+"</p>",a+='<div class="container-fluid myContainer inputFile">',a+='<div class="row my-row">',a+='<div class="col-xs-3 col-sm-3 col-md-3 my-col">',a+="<span>报销类型</span>",a+="</div>",a+='<div class="col-xs-9 col-sm-9 col-md-9 my-col">',a+='<input type="text" class="product" data-productid="" readonly="readonly" data-toggle="modal" data-target="#myModal" placeholder="请输入">',a+="</div>",a+="</div>",a+='<div class="row my-row">',a+='<div class="col-xs-4 col-sm-4 col-md-4 my-col">',a+="<span>报销金额(￥)</span>",a+="</div>",a+='<div class="col-xs-8 col-sm-8 col-md-8 my-col">',a+='<input type="number" class="itemAlltotals" data-count="0" placeholder="请输入">',a+="</div>",a+="</div>",a+='<div class="row my-row special-row">',a+='<div class="col-xs-3 col-sm-3 col-md-3 my-col">',a+="<span>费用说明</span>",a+='<span class="limit">(150字)</span>',a+="</div>",a+='<div class="col-xs-9 col-sm-9 col-md-9 my-col">',a+='<textarea class="remarks" placeholder="请输入" maxlength="150"></textarea>',a+="</div>",a+="</div>",a+="</div>",a+="</div>",$(o.config.inWrap).append(a),a=""},!1)},getCashierUser:function(){var e=this;$.ajax({url:getRoothPath+"/ddExpenses/userController/cashierUser.do",success:function(a){if("{}"===JSON.stringify(a))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(a.status){case"true":var t=a.info;if("{}"===JSON.stringify(t))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");var o=t.data;if(!o.length)return void $my.messageInfo.html("出纳人信息为空").fadeIn("fast").delay("1000").fadeOut("slow");for(var n="",r=0,s=o.length;r<s;r++)n+='<li class="cashier text-center" data-cashierUserID='+o[r].cashierUserID+">",n+='<div class="wating text-center progressBar">出纳</div>',n+='<p class="name">'+o[r].cashierUserName+"</p>",n+="</li>";e.config.cashierWrap.innerHTML=n;break;case"failure":$my.messageInfo.html("查询错误").fadeIn("fast").delay("1000").fadeOut("slow")}}})},calcExpenseTotal:function(){var e=this,a=/^\d+(\.\d+)?$/;$(e.config.inWrap).on("keyup",".itemAlltotals",function(t){var o=0;if(t.preventDefault(),t.stopPropagation(),""!=this.value){if(!a.test(this.value))return void $my.messageInfo.html("请输入非负浮点数").fadeIn("fast").delay("1000").fadeOut("slow");parseFloat(this.value)<=1e6?this.dataset.count=this.value:($my.messageInfo.html("单个报销金额最大100万").fadeIn("fast").delay("1500").fadeOut("slow"),this.value="",this.dataset.count=0)}else""==this.value&&(this.dataset.count=0);var n=$(this).parents("#inWrap")[0].querySelectorAll(".itemAlltotals");Array.prototype.forEach.call(n,function(e){o+=parseFloat(e.dataset.count)}),e.config.expenseTotal.value=o.toFixed(2)})},getEpUser:function(e){var a=this;if(null==e||"null"==e)return $my.messageInfo.html("用户ID丢失").fadeIn("fast").delay("1000").fadeOut("slow"),!1;$.ajax({url:getRoothPath+"/ddExpenses/userController/oldExpensesUser.do",data:{userID:e},success:function(e){if("{}"===JSON.stringify(e))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(e.status){case"true":var t=e.info;if("{}"===JSON.stringify(t))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");var o=t.data;if(o.length){for(var n="",r=0,s=o.length;r<s;r++)n+='<li class="nowrap text-center" data-oldEpUserID='+o[r].oldEpUserID+">"+o[r].oldEpUserUserName+"</li>";a.config.epUserWrap.innerHTML=n}break;case"failure":$my.messageInfo.html("查询错误").fadeIn("fast").delay("1000").fadeOut("slow")}}})},_renderDepartWrap:function(e){var a="",t=e.listUser,o=e.listDepart;if(o.length)for(var n=0,r=o.length;n<r;n++)a+='<div class="row my-row" data-departID='+o[n].departID+">",a+='<div class="col-xs-8 col-sm-8 col-md-8 my-col nowrap">',a+='<span class="departName">'+o[n].departName+"</span>",a+="</div>",a+='<div class="col-xs-4 col-sm-4 col-md-4 my-col text-right">',a+="<p><i>"+o[n].userCount+'</i>&nbsp;<span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></p>',a+="</div>",a+="</div>";if(t.length)for(var n=0,r=t.length;n<r;n++)a+='<div class="row my-row" data-departUserID='+t[n].departUserID+">",a+='<div class="col-xs-8 col-sm-8 col-md-8 my-col nowrap">',a+='<span class="departUserName">'+t[n].departUserName+"</span>",a+="</div>",a+='<div class="col-xs-4 col-sm-4 col-md-4 my-col text-right">',a+="<p></p>",a+="</div>",a+="</div>";this.config.departmentWrap.innerHTML=a,this.switchStr=!0},getDepart:function(e){var a=this;$.ajax({url:getRoothPath+"/ddExpenses/userController/getDepartOrUser.do",data:{departmentID:e},success:function(e){if("{}"===JSON.stringify(e))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(e.status){case"true":var t=e.info;if("{}"===JSON.stringify(t))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");a._renderDepartWrap(t);break;case"failure":$my.messageInfo.html("部门及人员获取错误").fadeIn("fast").delay("1000").fadeOut("slow")}}})},asyncGetDepart:function(){var e=this;$(departmentWrap).on("click",".row",function(a){a.preventDefault(),a.stopPropagation();var t=document.createElement("li"),o=this.dataset.departid,n="";if(this.querySelector(".departName"))n=this.querySelector(".departName").innerHTML,t="<li data-departmentID="+o+'><a href="javascript:;">'+n+"</a></li>",e.getDepart(o),$(e.config.breadcrumb).append(t);else{var r="",s="",l="";s=this.dataset.departuserid,r=this.querySelector(".departUserName").innerHTML,r.indexOf("-")>=0&&(r=r.substr(r.lastIndexOf("-")+1));var i=e.config.approverWrap.querySelectorAll("li");if(i.length>=10)return void $my.messageInfo.html("审批人最多添加9名").fadeIn("fast").delay("1000").fadeOut("slow");Array.prototype.forEach.call(i,function(e){if(s==e.dataset.userid)throw $my.messageInfo.html("该审批人已在列表中").fadeIn("fast").delay("1000").fadeOut("slow"),new Error("该审批人已在列表中")}),l='<li class="nowrap addPeople" data-userid='+s+">"+r+"</li>",e.config.addApprover.insertAdjacentHTML("beforeBegin",l),slideout.close()}var d=e.config.breadcrumb.querySelectorAll("li");d=Array.prototype.slice.call(d),d.pop();for(var c=0,p=d.length;c<p;c++)d[c].classList.add("active")})},crumbsEvent:function(){var e=this;$(breadcrumb).on("click","li",function(a){if(a.preventDefault(),a.stopPropagation(),e.switchStr&&this.classList.contains("active")){this.classList.remove("active"),e.switchStr=!1;var t="",o=this.dataset.departmentid,n=$(this).index(),r=this.parentNode.querySelectorAll("li");r=Array.prototype.slice.apply(r),r=r.slice(0,n+1);for(var s=0,l=r.length;s<l;s++)t+=r[s].outerHTML;e.config.breadcrumb.innerHTML=t,e.getDepart(o)}})},selectEpUser:function(){var e=this,a="",t="",o="";$(this.config.epUserWrap).on("click","li",function(n){n.preventDefault(),n.stopPropagation(),t=this.dataset.oldepuserid,a=this.innerHTML;var r=e.config.approverWrap.querySelectorAll("li");Array.prototype.forEach.call(r,function(e){if(t==e.dataset.userid)throw $my.messageInfo.html("该审批人已在列表中").fadeIn("fast").delay("1000").fadeOut("slow"),new Error("该审批人已在列表中")}),o='<li class="nowrap addPeople" data-userid='+t+">"+a+"</li>",e.config.addApprover.insertAdjacentHTML("beforeBegin",o),slideout.close()})},submitEvent:function(){if(approval.flag){var e=[],a=approval.config.expenseTotal.value,t=approval.config.bankAccount.value,o=approval.config.accountName.value,n=approval.config.accounNumber.value,r=approval.config.departWrapID.dataset.departmentinputid,s=[],l=[],i=[],d=[],c=approval.config.cashierWrap.querySelector("li.cashier").dataset.cashieruserid,p=approval.config.inWrap.querySelectorAll(".product"),u=approval.config.inWrap.querySelectorAll(".itemAlltotals"),f=approval.config.inWrap.querySelectorAll(".remarks"),m=approval.config.approverWrap.querySelectorAll(".nowrap"),g=approval.config.uploadWrap.querySelectorAll(".myImg"),h=[],v=[],y=approval.config.jobNum.value;p=Array.prototype.slice.apply(p),u=Array.prototype.slice.apply(u),f=Array.prototype.slice.apply(f),g=Array.prototype.slice.apply(g),Array.prototype.forEach.call(m,function(e){d.push(e.dataset.userid)});for(var I=0,w=g.length;I<w;I++)h.push(g[I].querySelector("img").dataset.src),v.push(g[I].querySelector("img").getAttribute("alt"));if(""==r||void 0==r||"undefined"==r)return void $my.messageInfo.html("请选择报销部门").fadeIn("fast").delay("1000").fadeOut("slow");for(var I=0,w=p.length;I<w;I++){if(""==p[I].dataset.productid)return void $my.messageInfo.html("请完善报销类型").fadeIn("fast").delay("1000").fadeOut("slow");if(""==u[I].value)return void $my.messageInfo.html("请完善报销金额").fadeIn("fast").delay("1000").fadeOut("slow");s.push(p[I].dataset.productid),l.push(u[I].value),""==f[I].value&&(f[I].value=" "),i.push(f[I].value)}if(""==t||""==o||""==n)return void $my.messageInfo.html("请完善收款信息").fadeIn("fast").delay("1000").fadeOut("slow");if(""==a)return void $my.messageInfo.html("报销总金额为空").fadeIn("fast").delay("1000").fadeOut("slow");if(""==approval.expenseImageUrl&&0===g.length)return void $my.messageInfo.html("请完善报销凭证").fadeIn("fast").delay("1000").fadeOut("slow");if(0===d.length)return void $my.messageInfo.html("请完善审批人").fadeIn("fast").delay("1000").fadeOut("slow");if(""==c)return void $my.messageInfo.html("出纳人信息为空").fadeIn("fast").delay("1000").fadeOut("slow");if(""==y)return void $my.messageInfo.html("请完善报销人工号").fadeIn("fast").delay("1000").fadeOut("slow");if(!/^\d{7}$/.test(y))return void $my.messageInfo.html("报销人工号不合法").fadeIn("fast").delay("1000").fadeOut("slow");s=s.join(),l=l.join(),i=i.join(),d=d.join();for(var I=0,w=approval.expenseImageUrl.length;I<w;I++)e.push(clouddnImgStr+"/"+approval.expenseImageUrl[I]);$.ajax({url:getRoothPath+"/ddExpenses/expense/updata.do",data:{departmentID:r,expenseID:approval.detailid,expenseTotal:a,submitUserID:$my.userID,bankAccount:t,accountName:o,accounNumber:n,producttypeIDs:s,itemAlltotals:l,remarks:i,expensesUserIDs:d,cashierUserID:c,expenseImageUrl:e.concat(h).join(),expenseImageName:approval.expenseImageName.concat(v).join(),loginName:y},beforeSend:function(){approval.flag=!1},success:function(e){if("{}"===JSON.stringify(e))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(e.status){case 1:var a=null;$my.messageInfo.html(e.msg).fadeIn("fast").delay("1000").fadeOut("slow"),function(){localStorage.removeItem("sessionTouchData_mySponser"),localStorage.removeItem("pageNum_mySponser"),localStorage.removeItem("dataCount_mySponser"),localStorage.removeItem("sessionTouchData_myApproval"),localStorage.removeItem("pageNum_myApproval"),localStorage.removeItem("dataCount_myApproval")}(),clearTimeout(a),a=setTimeout(function(){window.location.href="index.html"},1200);break;case 0:approval.flag=!0,$my.messageInfo.html("保存失败").fadeIn("fast").delay("1000").fadeOut("slow")}}}),function(){e=null,s=null,l=null,i=null,d=null,h=null,v=null}()}},addImage:function(){var e=this;e.config.uploadBtn.addEventListener("click",function(){$(myFile).trigger("click")},!1);var a=function(a){var t=document.createElement("img"),o=document.createElement("li");o.classList.add("newUploadImg"),t.setAttribute("alt",a.name),t.file=a,o.appendChild(t),$(e.config.uploadWrap).prepend(o);var n=new FileReader;n.onload=function(e){return function(a){e.src=a.target.result}}(t),n.readAsDataURL(a)};e.config.myFile.addEventListener("change",function(t){t.stopPropagation(),t.preventDefault();var o=new FormData,n=this.files;if(!(n.length<=9))return void $my.messageInfo.html("单次图片最多上传9张").fadeIn("fast").delay("1000").fadeOut("slow");var r=e.config.uploadWrap.querySelectorAll("li");if(r=Array.prototype.slice.apply(r),!(n.length<=10-r.length))return void $my.messageInfo.html("单次图片最多上传9张").fadeIn("fast").delay("1000").fadeOut("slow");for(var s=0,l=n.length;s<l;s++){var i=n[s],d=i.name.replace(/.+\./,"").toLowerCase();if("jpg"!==d&&"jpeg"!==d&&"png"!==d)return void $my.messageInfo.html("请选择扩展名.jpg/.jpeg/.png图片").fadeIn("fast").delay("1500").fadeOut("slow");if(i.size>5242880)return void $my.messageInfo.html("单张图片大小不可超过5M").fadeIn("fast").delay("1000").fadeOut("slow");o.append("files",i),a(i)}0!=n.length&&$.ajax({url:"http://www.ehaofangwang.com/publicshow/qiniuUtil/fileToQiniu.do",type:"POST",data:o,timeout:"",dataType:"json",cache:!1,contentType:!1,processData:!1,beforeSend:function(){$("#imgModalWrap").modal("show"),$("#imgModalWrap").modal({backdrop:"static",keyboard:!1})},success:function(a){if("{}"===JSON.stringify(a))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");var t=a.statas,n="",r="";switch(t){case"true":n=a.pathUrls.split(","),r=a.fileNames.split(","),Array.prototype.push.apply(e.expenseImageUrl,n),Array.prototype.push.apply(e.expenseImageName,r),$my.messageInfo.html(a.message).fadeIn("fast").delay("1000").fadeOut("slow");break;case"false":$my.messageInfo.html("上传失败,请重新上传").fadeIn("fast").delay("1500").fadeOut("slow"),o=null,n=[],r=[],$(e.config.uploadWrap).find("li.newUploadImg").remove()}},complete:function(){$("#imgModalWrap").modal("hide")},error:function(a){$("#imgModalWrap").modal("hide"),o=null,$(e.config.uploadWrap).find("li.newUploadImg").remove()}})},!1)},deleteApprover:function(){var e=this,a="";$(e.config.approverWrap).on("click",".nowrap",function(t){t.preventDefault(),t.stopPropagation(),a=$(this).index(),$(e.config.deleteApproverWrap).modal("show")}),e.config.cancleBtn.addEventListener("touchend",function(){$(e.config.deleteApproverWrap).modal("hide")},!1),e.config.confirmBtn.addEventListener("touchend",function(){var t=e.config.approverWrap.querySelectorAll(".nowrap");[].forEach.call(t,function(e,t){a==t&&e.parentNode.removeChild(e)}),$(e.config.deleteApproverWrap).modal("hide")},!1)},deleteOldImg:function(){var e=this,a="";$(e.config.uploadWrap).on("click",".myImg",function(t){t.preventDefault(),t.stopPropagation();var o=e.config.uploadWrap.querySelectorAll(".newUploadImg");a=$(this).index()-o.length,$(e.config.imgModal).modal("show")}),e.config.cancleBtn_img.addEventListener("touchend",function(){$(e.config.imgModal).modal("hide")},!1),e.config.confirmBtn_img.addEventListener("touchend",function(){var t=e.config.uploadWrap.querySelectorAll(".myImg");[].forEach.call(t,function(e,t){a==t&&e.parentNode.removeChild(e)}),$(e.config.imgModal).modal("hide")},!1)},deleteNewImg:function(){var e=this;$(e.config.uploadWrap).on("click","li.newUploadImg",function(a){a.preventDefault(),a.stopPropagation();for(var t=($(this).index(),$(this).children("img").attr("alt")),o=t.substring(0,t.lastIndexOf(".")),n=0,r=e.expenseImageName.length;n<r;n++)e.expenseImageName[n]===o&&(e.expenseImageName.splice(n,1),function(a){(function(){e.expenseImageUrl.splice(a,1)})()}(n));$(this).remove()})},_renderDepart:function(e,a){var t=this;$.ajax({url:getRoothPath+"/ddExpenses/userController/expenseDepartSearch.do",data:{name:e,parentID:a},success:function(e){if("{}"===JSON.stringify(e))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(e.status){case"true":var a=e.info;if("{}"===JSON.stringify(a))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");var o=a.data,n="";if(o.length&&0!=o.length){for(var r=0,s=o.length;r<s;r++)n+='<div class="row my-row" data-departmentwrapid='+o[r].departmentID+" data-type="+o[r].type+">",n+='<div class="col-xs-9 col-sm-9 col-md-9 my-col nowrap searchDepartName">',n+="<span>"+o[r].departName+"</span>",n+="</div>",n+='<div class="col-xs-3 col-sm-3 col-md-3 my-col text-right departConfirmBtn">',n+='<p><span class="glyphicon glyphicon-ok my-icon" aria-hidden="true"></span></p>',n+="</div>",n+="</div>";t.config.departmentContent.innerHTML=n}else n+='<div class="row my-row">',n+='<div class="col-xs-9 col-sm-9 col-md-9 my-col nowrap">',n+="<span>查询信息为空</span>",n+="</div>",n+='<div class="col-xs-3 col-sm-3 col-md-3 my-col text-right">',n+="<p></p>",n+="</div>",n+="</div>",t.config.departmentContent.innerHTML=n;break;case"failure":$my.messageInfo.html("报销部门查询错误").fadeIn("fast").delay("1000").fadeOut("slow")}},complete:function(){if(t.config.departmentContent.querySelectorAll(".row"))var e=t.config.departmentContent.querySelectorAll(".row");t.expenseDepartEvent(e)}})},expenseDepartSearch:function(){var e=this,a=function(){var a=this.value;e._renderDepart(a)};e.config.departSearch.addEventListener("input",e.throttleInput(a,500,1e3),!1)},expenseDepartEvent:function(e){var a=this,t=function(e,a){if(-1!==e.className.indexOf("my-col"))return e;if(e==a)return!1;for(;-1===e.className.indexOf("my-col");)e=e.parentNode;return e},o=function(e,a){return new RegExp("(^| )"+a+"( |$)","gi").test(e.className)};e&&[].forEach.call(e,function(e){e.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation();var n=this.dataset.type,r=this.dataset.departmentwrapid,s="";this.querySelector(".searchDepartName")&&(s=this.querySelector(".searchDepartName").querySelector("span").innerHTML);var l=this,i=e.target,d=t(i,l);if(d){if(o(d,"searchDepartName"))switch(n){case"0":break;case"1":a._renderDepart("",r)}else{if(l.querySelector(".departConfirmBtn")){var c=approval.config.departmentContent.querySelectorAll(".departConfirmBtn");[].forEach.call(c,function(e){e.querySelector(".my-icon").classList.remove("hasselect")}),l.querySelector(".departConfirmBtn").querySelector(".my-icon").classList.add("hasselect")}s&&r&&(a.config.departWrapID.value=s,a.config.departWrapID.dataset.departmentinputid=r),slideout.close()}}},!1)})},asideEvent:function(){var e=this;e.config.addApprover.addEventListener("click",function(a){a.preventDefault(),a.stopPropagation(),e.config.menu.getElementsByClassName("content")[0].classList.remove("hide"),e.config.menu.getElementsByClassName("content")[0].classList.add("show"),e.config.menu.querySelector(".depart").classList.remove("show"),e.config.menu.querySelector(".depart").classList.add("hide"),slideout.open()},!1),e.config.departWrapID.addEventListener("click",function(a){a.preventDefault(),a.stopPropagation(),e.config.menu.getElementsByClassName("content")[0].classList.remove("show"),e.config.menu.getElementsByClassName("content")[0].classList.add("hide"),e.config.menu.querySelector(".depart").classList.remove("hide"),e.config.menu.querySelector(".depart").classList.add("show"),slideout.open()},!1),e.config.closeBtn.addEventListener("touchend",function(e){e.preventDefault(),e.stopPropagation(),slideout.close()},!1),e.config.closeBtn_depart.addEventListener("touchend",function(e){e.preventDefault(),e.stopPropagation(),slideout.close()},!1)},jobNumEvent:function(){var e=this,a=/^[0-9]*$/,t=/^\d{7}$/,o=function(){if(!a.test(this.value))return $my.messageInfo.html("输入不合法").fadeIn("fast").delay("1000").fadeOut("slow"),void(this.value="");if(!t.test(this.value))return void $my.messageInfo.html("请输入7位数字").fadeIn("fast").delay("1000").fadeOut("slow");var o=this.value;$.ajax({url:getRoothPath+"/ddExpenses/userController/expenseUser.do",data:{loginName:o},success:function(a){if("{}"===JSON.stringify(a))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(a.status){case"true":var t=a.info;if("{}"===JSON.stringify(t))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");var o=t.data;if(!o.length)return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1500").fadeOut("slow");e.config.bankAccount.value=o[0].bankAccount,e.config.accountName.value=o[0].accountName,e.config.accounNumber.value=o[0].accounNumber;break;case"failure":$my.messageInfo.html("查询错误").fadeIn("fast").delay("1000").fadeOut("slow")}}})};e.config.jobNum.addEventListener("input",e.throttle(o,1500),!1)},expenseAName:function(){var e=this,a=/^[\u4e00-\u9fa5]{0,}$/,t=!0,o=e.config.groupWrap.querySelector("#inGroupWrap"),n=function(){var n=this.value;if(""==n&&(o.innerHTML="",e.config.groupWrap.classList.remove("show"),e.config.groupWrap.classList.add("hide")),t){if(!a.test(n))return void $my.messageInfo.html("请输入中文汉字").fadeIn("fast").delay("1500").fadeOut("slow");n.length>=2&&$.ajax({url:getRoothPath+"/ddExpenses/userController/expenseAName.do",data:{name:n},success:function(a){if("{}"===JSON.stringify(a))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(a.status){case"true":var t=a.info;if("{}"===JSON.stringify(t))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");var n=t.data;if(!n.length)return $my.messageInfo.html("返回信息为空,请重新输入").fadeIn("fast").delay("1500").fadeOut("slow"),o.innerHTML="",e.config.groupWrap.classList.remove("show"),void e.config.groupWrap.classList.add("hide");for(var r="",s=0,l=n.length;s<l;s++)r+='<li class="list-group-item" data-accountnameid='+n[s].id+">"+n[s].accountName+"</li>";o.innerHTML=r,e.config.groupWrap.classList.remove("hide"),e.config.groupWrap.classList.add("show");break;case"failure":$my.messageInfo.html("查询错误").fadeIn("fast").delay("1000").fadeOut("slow")}}})}};e.config.accountName.addEventListener("compositionstart",function(){o.innerHTML="",e.config.groupWrap.classList.remove("show"),e.config.groupWrap.classList.add("hide"),t=!1},!1),e.config.accountName.addEventListener("compositionend",function(){t=!0},!1),e.config.accountName.addEventListener("input",e.throttle(n,1e3),!1),e.config.accountName.addEventListener("blur",function(){o.innerHTML="",e.config.groupWrap.classList.add("hide")},!1)},expenseANameEvent:function(){var e=this,a=e.config.groupWrap.querySelector("#inGroupWrap");$(a).on("touchend","li",function(a){a.preventDefault(),a.stopPropagation(),e.config.groupWrap.classList.remove("show"),e.config.groupWrap.classList.add("hide");var t=this.dataset.accountnameid,o=this.innerHTML;e.config.accountName.value=o,$.ajax({url:getRoothPath+"/ddExpenses/userController/expenseBank.do",data:{id:t},success:function(a){if("{}"===JSON.stringify(a))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(a.status){case"true":var t=a.info;if("{}"===JSON.stringify(t))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");var o=t.data;if(!o.length)return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1500").fadeOut("slow");e.config.bankAccount.value=o[0].bankAccount,e.config.accounNumber.value=o[0].accounNumber;break;case"failure":$my.messageInfo.html("查询错误").fadeIn("fast").delay("1000").fadeOut("slow")}}})})},searchApprovalEvent:function(){var e=this,a=!0,t=function(){var t=this.value.trim();a&&(t?$.post(getRoothPath+"/ddExpenses/userController/userLike.do",{name:t},function(a){if("{}"===JSON.stringify(a))return $my.messageInfo.html("暂无数据").fadeIn("fast").delay("1000").fadeOut("slow"),!1;switch(a.status){case"true":var t=a.info;if("{}"===JSON.stringify(t))return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");var o=t.data;if(!o.length)return void $my.messageInfo.html("返回信息为空").fadeIn("fast").delay("1000").fadeOut("slow");for(var n="",r=0,s=o.length;r<s;r++)n+='<div class="row my-row" data-departuserid='+o[r].id+">",n+='<div class="col-xs-12 col-sm-12 col-md-12 my-col nowrap">',n+='<span class="departUserName">'+o[r].departName+"-"+o[r].userName+"</span>",n+="</div>",n+="</div>";e.config.departmentWrap.innerHTML=n;break;case"failure":$my.messageInfo.html("查询错误").fadeIn("fast").delay("1000").fadeOut("slow")}}):e.getDepart(0))};e.config.searchApprovalInput.addEventListener("compositionstart",function(){a=!1}),e.config.searchApprovalInput.addEventListener("compositionend",function(){a=!0}),e.config.searchApprovalInput.addEventListener("input",e.throttle(t,1e3),!1)},init:function(){this.getSessionData(),this.getDetailed(),this.getProductType(),this.getCashierUser(),this.addEvents(),this.calcExpenseTotal(),this.getDepart(0),this.asyncGetDepart(),this.getEpUser($my.userID),this.crumbsEvent(),this.selectEpUser(),this.addImage(),this.deleteApprover(),this.deleteOldImg(),this.deleteNewImg(),this.expenseDepartSearch(),this.expenseDepartEvent(),this.asideEvent(),this.jobNumEvent(),this.expenseAName(),this.expenseANameEvent(),this._renderDepart("",""),this.searchApprovalEvent()}};var approval=new Approval;$(function(){window.$my={messageInfo:$(".messageInfo"),userID:sessionStorage.getItem("ddUserID")},approval.init(),$("#imgModalWrap").on("show.bs.modal",function(){var e=$(this),a=e.find(".modal-dialog");e.css("display","block"),a.css({"margin-top":Math.max(0,($(window).height()-a.height())/2)})}),document.querySelector("#submitBtn").addEventListener("click",approval.throttle(approval.submitEvent,200),!1)});